// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User and Authentication Models
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?   // Nullable for OAuth-only users
  image         String?
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  animeLists    AnimeList[]
  reviews       Review[]
  reviewVotes   ReviewVote[]
  clubMemberships ClubMember[]
  clubPosts     ClubPost[]
  activities    Activity[]
  ratings       UserRating[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// Anime Models
model Anime {
  id                Int       @id // AniList ID
  title             String
  titleEnglish      String?
  titleRomaji       String?
  description       String?
  coverImage        String?
  bannerImage       String?
  genres            String[]
  tags              String[]
  averageScore      Float?
  popularity        Int?
  episodes          Int?
  status            String?   // FINISHED, RELEASING, NOT_YET_RELEASED, CANCELLED
  season            String?
  seasonYear        Int?
  format            String?   // TV, MOVIE, OVA, ONA, SPECIAL
  startDate         DateTime?
  endDate           DateTime?
  studios           String[]
  externalLinks     Json?
  nextAiringEpisode Json?     // {episode: number, airingAt: timestamp}
  cachedAt          DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  episodeList       Episode[]
  animeLists        AnimeList[]
  reviews           Review[]
  userRatings       UserRating[]

  @@map("anime")
}

model Episode {
  id            String    @id @default(cuid())
  animeId       Int
  number        Int
  title         String?
  description   String?
  thumbnail     String?
  streamingUrl  String?
  isFiller      Boolean   @default(false)
  isManga       Boolean   @default(false)
  airingDate    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  anime         Anime     @relation(fields: [animeId], references: [id], onDelete: Cascade)

  @@unique([animeId, number])
  @@index([airingDate])
  @@map("episodes")
}

// User List Models
enum ListStatus {
  WATCHING
  COMPLETED
  PLAN_TO_WATCH
  DROPPED
  ON_HOLD
}

model AnimeList {
  id              String      @id @default(cuid())
  userId          String
  animeId         Int
  status          ListStatus
  score           Float?      @db.Real
  progress        Int         @default(0)
  startedAt       DateTime?
  completedAt     DateTime?
  notes           String?
  isFavorite      Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime           Anime       @relation(fields: [animeId], references: [id], onDelete: Cascade)

  @@unique([userId, animeId])
  @@index([userId, status])
  @@map("anime_lists")
}

// Review Models
model Review {
  id          String       @id @default(cuid())
  userId      String
  animeId     Int
  rating      Float        @db.Real
  title       String
  content     String
  spoilers    Boolean      @default(false)
  helpfulCount Int         @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime       Anime        @relation(fields: [animeId], references: [id], onDelete: Cascade)
  votes       ReviewVote[]

  @@unique([userId, animeId])
  @@index([animeId])
  @@map("reviews")
}

model ReviewVote {
  id        String   @id @default(cuid())
  userId    String
  reviewId  String
  helpful   Boolean  // true = helpful, false = not helpful
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@unique([userId, reviewId])
  @@map("review_votes")
}

// Club Models
model Club {
  id          String       @id @default(cuid())
  name        String
  description String
  avatar      String?
  isPublic    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  members     ClubMember[]
  posts       ClubPost[]

  @@map("clubs")
}

enum ClubRole {
  OWNER
  MODERATOR
  MEMBER
}

model ClubMember {
  id        String     @id @default(cuid())
  clubId    String
  userId    String
  role      ClubRole   @default(MEMBER)
  joinedAt  DateTime   @default(now())

  club      Club       @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@map("club_members")
}

model ClubPost {
  id        String   @id @default(cuid())
  clubId    String
  userId    String
  title     String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  club      Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@map("club_posts")
}

// Activity Feed Models
enum ActivityType {
  LIST_UPDATE
  REVIEW_POSTED
  CLUB_JOINED
  CLUB_POST
  ANIME_COMPLETED
}

model Activity {
  id          String        @id @default(cuid())
  userId      String
  type        ActivityType
  metadata    Json          // Flexible data for different activity types
  createdAt   DateTime      @default(now())

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([createdAt])
  @@map("activities")
}

// Recommendation System Models
model UserRating {
  id        String   @id @default(cuid())
  userId    String
  animeId   Int
  rating    Float    @db.Real
  implicit  Boolean  @default(false) // true if derived from list status/progress
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime     Anime    @relation(fields: [animeId], references: [id], onDelete: Cascade)

  @@unique([userId, animeId])
  @@index([userId])
  @@index([animeId])
  @@map("user_ratings")
}
